<!DOCTYPE html>
<html>
<head>
  <title>Leaflet</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ==" crossorigin=""/>
  <link rel="stylesheet" href="assets/leaflet.groupedlayercontrol.min.css"/>
  <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js" integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw==" crossorigin=""></script>
  <script src='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.3.1/leaflet-omnivore.min.js'></script>
  <script src='assets/leaflet.groupedlayercontrol.min.js'></script>
  <script src='assets/Leaflet.Icon.Glyph.js'></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.3.0/leaflet.markercluster.js" integrity="sha256-3ojygIn9E2azRCTFNSS+qcVr8FT9yfpol9iG2ZaRz4w=" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.3.0/MarkerCluster.Default.css" integrity="sha256-LWhzWaQGZRsWFrrJxg+6Zn8TT84k0/trtiHBc6qcGpY=" crossorigin="anonymous" />
  <script src="https://unpkg.com/leaflet.featuregroup.subgroup@1.0.2/dist/leaflet.featuregroup.subgroup.js"></script>
  <link rel="stylesheet" href="/assets/style.css">
</head>
<body>
  <div id="map"></div>
  <script>
    Object.values = Object.values || function(o){return Object.keys(o).map(function(k){return o[k]})};

    function addToDict(dict, key, value) {
      var added = false;
      keys.forEach(function(key) {
        var properties = value.feature.properties;
        var keyName = 'Implique ' + key.replace('nb_', '');
        if (!(dict.hasOwnProperty(keyName))) {
          dict[keyName] = L.featureGroup.subGroup(markers);
        }
        if (properties[key] > '0') {
          added = true;
          value.addTo(dict[keyName]);
        }
      })
      if (!added) {
        value.addTo(dict['Sans flotteur']);
      }
    }

    var tileLayers = {
      'Main': L.tileLayer('https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png', {
        maxZoom: 20,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
      }),
      'SHOM': L.tileLayer(
        'https://geoapi.fr/shomgt/tile.php/gtpyr/{z}/{x}/{y}.png',
        {"format":"png", "minZoom":0, "maxZoom":18, "detectRetina":false, "attribution": '<a href="http://www.shom.fr/">SHOM</a>'}
      ),
      'SeaMap': L.tileLayer('http://server.arcgisonline.com/ArcGIS/rest/services/Ocean_Basemap/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles &copy; Esri &mdash; Sources: GEBCO, NOAA, CHS, OSU, UNH, CSUMB, National Geographic, DeLorme, NAVTEQ, and Esri',
      }),
      'IGN Littoral': L.tileLayer('https://wxs.ign.fr/an7nvfzojv5wa96dsga5nk8w/geoportail/wmts?layer=GEOGRAPHICALGRIDSYSTEMS.COASTALMAPS&style=normal&tilematrixset=PM&Service=WMTS&Request=GetTile&Version=1.0.0&Format=image%2Fpng&TileMatrix={z}&TileCol={x}&TileRow={y}', {
        attribution: '&copy; https://www.geoportail.gouv.fr',
      })
    };
    var floatTypes = {};
    var markers = L.markerClusterGroup({ disableClusteringAtZoom: 13});
    floatTypes['Sans flotteur'] = L.featureGroup.subGroup(markers);

    var points = omnivore.csv('data_etel.csv')
    .on('error', function(error) {
      console.error(error);
    })
    .on('ready', function(layer) {
      this.eachLayer(function(marker) {
        var properties = marker.feature.properties;
        var popupContent = Object.keys(properties).map(function(key) {return key + " : " + properties[key]}).join("<br>")
        marker.bindPopup(popupContent);
        marker.setIcon(L.icon.glyph({
          glyph: properties.type,
          className: 'marker-icon-' + properties.type.toLowerCase(),
          iconUrl: '/assets/images/markers-soft.png',
          iconSize: [35, 46]
        }));
        markers.addLayer(marker);
        keys = ['nb_aeronef','nb_autre','nb_commerce','nb_loisir_nautique','nb_peche','nb_plaisance']
        addToDict(floatTypes, keys, marker);
      });

      var map = L.map('map', {
        center: new L.LatLng(48.8531, 2.3664),
        zoom: 7,
        layers: [tileLayers['Main']].concat(Object.values(floatTypes), markers)
      });

      var groups = {
        "Flotteurs impliqu√©s": floatTypes,
      }
      L.control.groupedLayers(tileLayers, groups, {position:'topleft', groupCheckboxes: true, collapsed: true}).addTo(map);
      L.control.scale({imperial: false}).addTo(map);
    });
  </script>
</body>
</html>
