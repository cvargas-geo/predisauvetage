<!DOCTYPE html>
<html>
<head>
  <title>Leaflet</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ==" crossorigin=""/>
  <link rel="stylesheet" href="assets/leaflet.groupedlayercontrol.min.css"/>
  <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js" integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw==" crossorigin=""></script>
  <script src='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.3.1/leaflet-omnivore.min.js'></script>
  <script src='assets/leaflet.groupedlayercontrol.min.js'></script>
  <script src='assets/Leaflet.Icon.Glyph.js'></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.3.0/leaflet.markercluster.js" integrity="sha256-3ojygIn9E2azRCTFNSS+qcVr8FT9yfpol9iG2ZaRz4w=" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.3.0/MarkerCluster.Default.css" integrity="sha256-LWhzWaQGZRsWFrrJxg+6Zn8TT84k0/trtiHBc6qcGpY=" crossorigin="anonymous" />
  <script src="https://unpkg.com/leaflet.featuregroup.subgroup@1.0.2/dist/leaflet.featuregroup.subgroup.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/6.0.7/highcharts.js" integrity="sha256-F0xKYvUdYPCgKKgKGtEjxwHXKSRbwKP+2mOlgGoR0Fs=" crossorigin="anonymous"></script>
  <style>
    body {
      padding: 0;
      margin: 0;
    }
    html, body, #map {
      height: 100%;
      width: 100%;
    }
    #map {
      z-index: 1;
    }
    .stats {
      position: absolute;
      height: 200px;
      width: 600px;
      z-index: 2;
      display: none;
    }
    #stats-event-types {
      bottom: 20px;
      right: 0px;
    }
    #stats-casualties {
      bottom: 220px;
      right: 0px;
    }
  </style>
</head>
<body>
  <div id="stats-event-types" class="stats"></div>
  <div id="stats-casualties" class="stats"></div>
  <div id="map"></div>
  <script>
    Object.values = Object.values || function(o){return Object.keys(o).map(function(k){return o[k]})};

    function addToDict(dict, key, value) {
      if (!(dict.hasOwnProperty(key))) {
        dict[key] = L.featureGroup.subGroup(markers);
      }
      value.addTo(dict[key]);
    }

    var tileLayers = {
      'Main': L.tileLayer('https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png', {
        maxZoom: 20,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
      }),
      'SeaMap': L.tileLayer('http://server.arcgisonline.com/ArcGIS/rest/services/Ocean_Basemap/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles &copy; Esri &mdash; Sources: GEBCO, NOAA, CHS, OSU, UNH, CSUMB, National Geographic, DeLorme, NAVTEQ, and Esri',
      })
    };
    var operationTypes = {};
    var eventTypes = {};
    var markers = L.markerClusterGroup({ maxClusterRadius: function(zoom) {return (zoom > 10) ? 40 : 80}});

    var points = omnivore.csv('data.csv')
    .on('error', function(error) {
      console.error(error);
    })
    .on('ready', function(layer) {
      this.eachLayer(function(marker) {
        var properties = marker.feature.properties;
        var popupContent = Object.keys(properties).map(function(key) {return key + " : " + properties[key]}).join("<br>")
        marker.bindPopup(popupContent);
        marker.setIcon(L.icon.glyph({glyph: properties.type}));
        markers.addLayer(marker);
        addToDict(operationTypes, properties.type, marker);
        addToDict(eventTypes, properties.evenement, marker);
      });

      var map = L.map('map', {
        center: new L.LatLng(48.8531, 2.3664),
        zoom: 7,
        layers: [tileLayers['Main']].concat(Object.values(eventTypes), Object.values(operationTypes), markers)
      });
      function refreshStats() {
        var contained = [];
        markers.eachLayer(function(layer) {
          if (map.getBounds().contains(layer.getLatLng())) {
            contained.push(layer);
          }
        });
        eventsInZone.series[0].setData(toData(eventsCount(contained)));
        casulatiesInZone.series[0].setData(toData(casualtiesCount(contained)));
        if (contained.length > 0) {
          document.getElementById("stats-event-types").style.display = 'block';
          document.getElementById("stats-casualties").style.display = 'block';
        }
        else {
          document.getElementById("stats-event-types").style.display = 'none';
          document.getElementById("stats-casualties").style.display = 'none';
        }
      }
      function eventsCount(points) {
        var res = {};
        points.forEach(function(point) {
          var type = point.feature.properties.evenement;
          if (!res.hasOwnProperty(type)) {
            res[type] = 0;
          }
          res[type] += 1;
        });
        return res;
      }
      function casualtiesCount(points) {
        var res = {};
        points.forEach(function(point) {
          var cols = [
            "nb_personnes_asssistées",
            "nb_décédés_accidentels",
            "nb_décédés_naturels",
            "nb_personnes_disparues",
            "nb_personnes_impliquées_fausses_alertes",
            "nb_personnes_retrouvées",
            "nb_personnes_secourues",
            "nb_personnes_tirées_daffaires_elles_memes"
          ]
          var mapping = {
            "nb_personnes_asssistées" : "Assistées",
            "nb_décédés_accidentels" : "Décédés accidentels",
            "nb_décédés_naturels" : "Décédés naturels",
            "nb_personnes_disparues" : "Disparues",
            "nb_personnes_impliquées_fausses_alertes" : "Impliquées dans fausses alertes",
            "nb_personnes_retrouvées" : "Retrouvées",
            "nb_personnes_secourues" : "Secourues",
            "nb_personnes_tirées_daffaires_elles_memes" : "Tirées d'affaires elles-mêmes"
          }
          cols.forEach(function(col) {
            var value = parseInt(point.feature.properties[col]);
            if (value === 0) {
              return
            }
            var name = mapping[col];
            if (!res.hasOwnProperty(name)) {
              res[name] = value;
            }
            res[name] += value;
          })
        });
        return res;
      }
      function toData(src) {
        var res = [];
        for (var k in src) {
          res.push({name: k, y: src[k]})
        }
        return res
      }
      ['zoomend', 'moveend', 'overlayadd', 'overlayremove'].forEach(function(event) {
        map.on(event, function() { refreshStats() });
      });

      var groups = {
        "Évenement": eventTypes,
        "Type d'opération": operationTypes,
      }
      L.control.groupedLayers(tileLayers, groups, {position:'topleft', groupCheckboxes: true, collapsed: true}).addTo(map);
      L.control.scale({imperial: false}).addTo(map);

      var eventsInZone = Highcharts.chart('stats-event-types', {
        chart: {
          type: 'pie'
        },
        title: {
          text: "Type d'événements dans la zone"
        },
        tooltip: {
          pointFormat: '{series.name}: <b>{point.y} ({point.percentage:.1f}%)</b>'
        },
        plotOptions: {
          pie: {
            cursor: 'pointer',
            dataLabels: {
              enabled: true,
              format: '<b>{point.name}</b>: {point.percentage:.1f} %',
              style: {
                color: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black'
              }
            }
          }
        },
        series: [{
          name: 'Événements',
          colorByPoint: true,
          data: []
        }]
      });
      var casulatiesInZone = Highcharts.chart('stats-casualties', {
        chart: {
          type: 'pie'
        },
        title: {
          text: "Bilan humain dans la zone"
        },
        tooltip: {
          pointFormat: '{series.name}: <b>{point.y} ({point.percentage:.1f}%)</b>'
        },
        plotOptions: {
          pie: {
            cursor: 'pointer',
            dataLabels: {
              enabled: true,
              format: '<b>{point.name}</b>: {point.percentage:.1f} %',
              style: {
                color: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black'
              }
            }
          }
        },
        series: [{
          name: 'Nombre',
          colorByPoint: true,
          data: []
        }]
      });
    });
  </script>
</body>
</html>
